<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Social Arbitrage</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1621;
      --panel2: #0c121b;
      --text: #e6eef8;
      --muted: #94a3b8;
      --border: rgba(148,163,184,0.18);
      --green: #34d399;
      --amber: #fbbf24;
      --red: #fb7185;
      --chip: rgba(148,163,184,0.12);
      --chip2: rgba(52,211,153,0.15);
      --accent: #22c55e;
      --shadow: 0 12px 30px rgba(0,0,0,0.35);
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(34,197,94,0.18), transparent 60%),
                  radial-gradient(1000px 600px at 90% -15%, rgba(59,130,246,0.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
    }

    a { color: #7dd3fc; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .wrap { max-width: 1280px; margin: 0 auto; padding: 18px 18px 28px; }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
      background: rgba(11,15,20,0.72);
      border-bottom: 1px solid var(--border);
    }

    .topbar-inner { display:flex; align-items:center; gap:14px; padding: 14px 18px; max-width: 1280px; margin: 0 auto; }

    .brand {
      display:flex; align-items:center; gap:10px;
      font-weight: 750; letter-spacing: 0.2px;
    }
    .dot { width: 9px; height: 9px; border-radius: 999px; background: var(--accent); box-shadow: 0 0 20px rgba(34,197,94,0.75); }

    .stats { display:flex; gap: 12px; flex-wrap: wrap; align-items:center; }
    .stat { color: var(--muted); font-size: 12px; }
    .stat b { color: var(--text); font-weight: 700; }

    .right { margin-left:auto; display:flex; align-items:center; gap:10px; }
    .pill { padding: 6px 10px; border: 1px solid var(--border); background: rgba(15,22,33,0.6); border-radius: 999px; color: var(--muted); font-size: 12px; }

    .controls {
      margin-top: 18px;
      display:grid;
      grid-template-columns: 1.6fr 1fr 1fr 1fr 1fr;
      gap: 10px;
      align-items: end;
    }

    .card {
      background: linear-gradient(180deg, rgba(15,22,33,0.88), rgba(12,18,27,0.88));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
    }

    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(3,7,12,0.55);
      color: var(--text);
      outline: none;
    }

    textarea { min-height: 140px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }

    .btn {
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,22,33,0.7);
      color: var(--text);
      padding: 10px 12px;
      font-weight: 650;
    }
    .btn.primary { border-color: rgba(34,197,94,0.45); background: rgba(34,197,94,0.12); }

    .row { display:flex; gap:10px; align-items:center; }
    .chips { display:flex; gap:6px; flex-wrap: wrap; }
    .chip {
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip);
      color: var(--muted);
      font-size: 12px;
      user-select: none;
    }
    .chip.green { background: var(--chip2); color: #b9f6d1; border-color: rgba(34,197,94,0.35); }

    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    thead th {
      text-align: left;
      font-size: 12px;
      color: var(--muted);
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 58px;
      background: rgba(11,15,20,0.84);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    thead th.sortable { cursor: pointer; user-select: none; }
    thead th.sortable:hover { color: var(--text); }
    thead th.sortable.active { color: var(--text); }
    .sort-ind { margin-left: 6px; font-size: 11px; opacity: 0.9; }
    tbody td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(148,163,184,0.10);
      vertical-align: top;
      font-size: 13px;
      line-height: 1.35;
    }

    .badge { display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background: rgba(148,163,184,0.08); }
    .badge.high { border-color: rgba(52,211,153,0.35); color: #b9f6d1; background: rgba(52,211,153,0.10); }
    .badge.med { border-color: rgba(251,191,36,0.35); color: #fde68a; background: rgba(251,191,36,0.10); }
    .badge.low { border-color: rgba(251,113,133,0.35); color: #fecdd3; background: rgba(251,113,133,0.10); }

    .small { font-size: 12px; color: var(--muted); }

    .split {
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 1000px) {
      .controls { grid-template-columns: 1fr; }
      .split { grid-template-columns: 1fr; }
      thead th { top: 0; position: static; }
    }

    /* item side panel */
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
      z-index: 40;
    }
    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: min(520px, 92vw);
      background: linear-gradient(180deg, rgba(15,22,33,0.96), rgba(12,18,27,0.96));
      border-left: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 50;
      padding: 14px;
      overflow: auto;
    }
    .hidden { display: none; }
    .drawer h3 { margin: 0; font-size: 16px; }
    .drawer .meta { color: var(--muted); font-size: 12px; margin-top: 6px; line-height: 1.4; }
    .drawer .shots {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }
    .drawer img {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.18);
      display: block;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand"><span class="dot"></span> Social Arbitrage</div>
      <div class="stats" id="stats"></div>
      <div class="right">
        <div class="pill" id="live">Live</div>
        <div class="pill" id="status">…</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="controls">
      <div class="card">
        <label>Search (brand, ticker, context)</label>
        <input id="q" placeholder="e.g., Starbucks cup / SBUX / labubu" />
        <div class="row" style="margin-top:10px; justify-content: space-between;">
          <div class="chips" id="topChips"></div>
          <button class="btn primary" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div class="card">
        <label>Type</label>
        <select id="type">
          <option value="all">All</option>
          <option value="public">Public only</option>
          <option value="private">Private only</option>
        </select>
      </div>

      <div class="card">
        <label>Source</label>
        <select id="source">
          <option value="all">All sources</option>
          <option value="tiktok">TikTok</option>
          <option value="x_mock">X (mock)</option>
          <option value="hn">HN</option>
          <option value="rss">RSS</option>
          <option value="reddit">Reddit</option>
        </select>
      </div>

      <div class="card">
        <label>Confidence</label>
        <select id="conf">
          <option value="all">All</option>
          <option value="high">High</option>
          <option value="med">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>

      <div class="card">
        <label>Min score</label>
        <input id="minScore" type="number" step="0.01" value="0.65" />
      </div>
    </div>

    <div class="split">
      <div class="card">
        <div class="row" style="justify-content: space-between;">
          <div>
            <div style="font-weight:700;">Keywords</div>
            <div class="small">Edit the rotating keyword list (one per line). This updates <code>config/keywords.txt</code>.</div>
          </div>
          <button class="btn" id="loadKw">Load</button>
        </div>
        <textarea id="kw"></textarea>
        <div class="row" style="justify-content: space-between; margin-top:10px;">
          <div class="small" id="kwStatus"></div>
          <button class="btn primary" id="saveKw">Save keywords</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;">Notes</div>
        <div class="small" style="margin-top:6px;">
          This dashboard is intentionally no-framework (single HTML file). It shows the top scored “signals” from SQLite.
          Use the search + filters to find brands/tickers quickly.
        </div>
        <div class="small" style="margin-top:10px;">
          Tip: If TikTok links look empty, run one headful ingest first to log in:
          <code>TIKTOK_COLLECTOR=playwright TIKTOK_HEADLESS=0 moondev-clawdbot ingest --sources tiktok</code>
        </div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th data-sort="fetched_at" class="sortable" style="width:130px;">Time<span class="sort-ind"></span></th>
          <th data-sort="ticker" class="sortable" style="width:110px;">Ticker<span class="sort-ind"></span></th>
          <th data-sort="trend" class="sortable" style="width:260px;">Trend<span class="sort-ind"></span></th>
          <th data-sort="source" class="sortable" style="width:130px;">Source<span class="sort-ind"></span></th>
          <th data-sort="score" class="sortable" style="width:120px;">Conf<span class="sort-ind"></span></th>
          <th data-sort="context" class="sortable">Context<span class="sort-ind"></span></th>
          <th data-sort="exposure" class="sortable" style="width:220px;">Exposure<span class="sort-ind"></span></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <!-- Side panel for viewing an item + screenshots -->
  <div id="backdrop" class="backdrop hidden"></div>
  <div id="drawer" class="drawer hidden">
    <div class="row" style="justify-content: space-between; align-items:center;">
      <div style="font-weight:750;">Item</div>
      <button class="btn" id="closeDrawer">Close</button>
    </div>
    <div id="drawerBody" style="margin-top:12px;"></div>
  </div>

<script>
  function escapeHtml(s) {
    return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function escapeAttr(s) {
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;');
  }

  function badgeHtml(bucket) {
    const c = (bucket||'').toLowerCase();
    if (c.startsWith('h')) return `<span class="badge high">HIGH</span>`;
    if (c.startsWith('m')) return `<span class="badge med">MED</span>`;
    if (c.startsWith('l')) return `<span class="badge low">LOW</span>`;
    return `<span class="badge">—</span>`;
  }

  function parseMetrics(r) {
    try { return JSON.parse(r.metrics_json || '{}'); } catch(e) { return {}; }
  }

  function fmtTime(iso) {
    if (!iso) return '';
    // show local-ish short
    try {
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${mm}/${dd} ${hh}:${mi}`;
    } catch(e) {
      return iso;
    }
  }

  function investableType(m) {
    const inv = m.investable || m.investable_hits || null;
    if (!inv || !Array.isArray(inv) || inv.length === 0) return 'unknown';
    const anyTicker = inv.some(x => x && x.ticker);
    return anyTicker ? 'public' : 'private';
  }

  function extractBrandTicker(m, titleText) {
    // Prefer explicit investable mapping
    const inv = (m.investable || []).filter(Boolean);
    const tickers = [];
    const brands = [];
    for (const x of inv) {
      if (x.brand) brands.push(x.brand);
      if (x.ticker) tickers.push(x.ticker);
      if (x.parent && x.brand) brands.push(`${x.brand} → ${x.parent}`);
    }

    // fallback: from detected_tickers / brands
    if (Array.isArray(m.tickers)) tickers.push(...m.tickers);
    if (Array.isArray(m.brands)) brands.push(...m.brands);

    const ticker = tickers[0] || '';
    const brand = brands[0] || (titleText || '').slice(0, 60);
    return { ticker, brand };
  }

  function confBucket(score) {
    const s = Number(score ?? 0);
    if (s >= 0.78) return 'high';
    if (s >= 0.68) return 'med';
    return 'low';
  }

  function confCell(score) {
    const bucket = confBucket(score);
    const s = (score === null || score === undefined || Number.isNaN(Number(score))) ? '—' : Number(score).toFixed(2);
    return `<div class="row" style="gap:8px; align-items:center;">${badgeHtml(bucket)}<span class="small">${escapeHtml(s)}</span></div>`;
  }

  // item drawer
  const backdrop = document.getElementById('backdrop');
  const drawer = document.getElementById('drawer');
  const drawerBody = document.getElementById('drawerBody');

  function closeDrawer() {
    drawer.classList.add('hidden');
    backdrop.classList.add('hidden');
    drawerBody.innerHTML = '';
  }

  function renderKV(k, v) {
    if (!v) return '';
    if (Array.isArray(v)) v = v.join(' ');
    return `<div class="meta"><b>${escapeHtml(k)}:</b> ${escapeHtml(v)}</div>`;
  }

  async function openDrawer(itemId) {
    drawer.classList.remove('hidden');
    backdrop.classList.remove('hidden');
    drawerBody.innerHTML = `<div class="small">Loading…</div>`;

    const res = await fetch(`/api/item?id=${encodeURIComponent(itemId)}`);
    const j = await res.json();
    if (!j || !j.ok) {
      drawerBody.innerHTML = `<div class="small">Error loading item.</div>`;
      return;
    }

    const it = j.item || {};
    const m = it.metrics || {};
    const ve = (m && typeof m === 'object') ? (m.llm_enrich || null) : null;
    const shots = it.screenshot_urls || [];

    const risk = (ve && ve.risk_flags) ? ve.risk_flags : (m.risk_flags || null);
    const riskBits = [];
    if (risk && typeof risk === 'object') {
      if (risk.ad_sponsored) riskBits.push('ad/sponsored');
      if (risk.misinformation_or_medical_claim) riskBits.push('misinfo/medical');
      if (risk.scam_or_impersonation) riskBits.push('scam/impersonation');
    }

    const header = `
      <h3>${escapeHtml(it.title || '(item)')}</h3>
      <div class="meta">
        <a href="${escapeAttr(it.url || '')}" target="_blank" rel="noreferrer">Open link</a>
        ${riskBits.length ? ` • <span class="chip">risk: ${escapeHtml(riskBits.join(', '))}</span>` : ''}
      </div>
      ${renderKV('creator', m.creator)}
      ${renderKV('hashtags', m.hashtags)}
      ${renderKV('sound', [m.sound_title, m.sound_artist].filter(Boolean).join(' — '))}
      ${renderKV('vision trend', ve && ve.main_trend)}
      ${renderKV('vision context', ve && ve.context)}
      ${renderKV('summary', m.context_summary)}
      ${renderKV('why spreading', (ve && ve.why_spreading) ? ve.why_spreading : m.why_spreading)}
    `;

    const cands = (ve && Array.isArray(ve.candidates)) ? ve.candidates : [];
    const candHtml = cands.length ? `
      <div style="margin-top:12px; font-weight:700;">Candidates</div>
      <div class="meta">${cands.slice(0,5).map(c => {
        const t = escapeHtml(c.asset_type || 'other');
        const sym = escapeHtml(c.symbol || '');
        const nm = escapeHtml(c.name || '');
        const cf = (c.confidence === null || c.confidence === undefined) ? '' : ` (${Number(c.confidence).toFixed(2)})`;
        const why = escapeHtml(c.reason || '');
        return `<div class="meta"><span class="chip">${t}${sym ? `:${sym}` : ''}${cf}</span> ${nm}${why ? ` — ${why}` : ''}</div>`;
      }).join('')}</div>
    ` : '';

    const shotsHtml = shots.length ? `
      <div style="margin-top:12px; font-weight:700;">Screenshots</div>
      <div class="shots">${shots.map(u => `<a href="${escapeAttr(u)}" target="_blank" rel="noreferrer"><img src="${escapeAttr(u)}" loading="lazy" /></a>`).join('')}</div>
    ` : `<div class="small" style="margin-top:12px;">No screenshots on this item.</div>`;

    drawerBody.innerHTML = header + candHtml + shotsHtml;
  }

  document.getElementById('closeDrawer').addEventListener('click', closeDrawer);
  backdrop.addEventListener('click', closeDrawer);

  // client-side sorting state
  let sortState = { key: 'score', dir: 'desc' };

  function updateSortIndicators() {
    document.querySelectorAll('th[data-sort]').forEach(th => {
      const key = th.getAttribute('data-sort');
      const ind = th.querySelector('.sort-ind');
      const active = (key === sortState.key);
      th.classList.toggle('active', active);
      if (ind) ind.textContent = active ? (sortState.dir === 'asc' ? '▲' : '▼') : '';
    });
  }

  function sortRows(rows) {
    const key = sortState.key;
    if (!key) return rows;

    function val(x) {
      if (key === 'fetched_at') return Date.parse(x.r.fetched_at || '') || 0;
      if (key === 'ticker') return (x.ticker || '').toLowerCase();
      if (key === 'trend') return (x.trend || '').toLowerCase();
      if (key === 'brand') return (x.brand || '').toLowerCase();
      if (key === 'source') return (x.r.source || '').toLowerCase();
      if (key === 'score') return (x.r.score === null || x.r.score === undefined) ? null : Number(x.r.score);
      if (key === 'context') return (x.context || '').toLowerCase();
      if (key === 'exposure') return (x.exposure || '').toLowerCase();
      return '';
    }

    function isNil(v) {
      return v === null || v === undefined || v === '' || (typeof v === 'number' && Number.isNaN(v));
    }

    const dirMul = (sortState.dir === 'asc') ? 1 : -1;

    const withIndex = rows.map((x, i) => ({ ...x, _i: i }));
    withIndex.sort((a, b) => {
      const av = val(a);
      const bv = val(b);

      // Always push missing values to the bottom (regardless of direction)
      if (isNil(av) && isNil(bv)) return a._i - b._i;
      if (isNil(av)) return 1;
      if (isNil(bv)) return -1;

      let cmp = 0;
      if (typeof av === 'number' && typeof bv === 'number') {
        cmp = av - bv;
      } else {
        cmp = String(av).localeCompare(String(bv));
      }

      if (cmp === 0) return a._i - b._i; // stable
      return cmp * dirMul;
    });

    return withIndex;
  }

  function setupSorting() {
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-sort');
        if (!key) return;

        if (sortState.key === key) {
          sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
        } else {
          sortState.key = key;
          sortState.dir = (key === 'score' || key === 'fetched_at') ? 'desc' : 'asc';
        }

        updateSortIndicators();
        loadSignals().catch(()=>{});
      });
    });

    updateSortIndicators();
  }

  async function loadSignals() {
    const minScore = parseFloat(document.getElementById('minScore').value || '0');
    const status = document.getElementById('status');
    status.textContent = 'Loading…';

    const res = await fetch(`/api/signals?min_score=${encodeURIComponent(minScore)}`);
    const data = await res.json();
    const items = data.items || [];

    // stats
    const stats = { total: items.length, public: 0, private: 0, high: 0, today: 0 };
    const now = new Date();
    const todayKey = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()}`;

    const byTicker = new Map();

    // build filtered list
    const q = (document.getElementById('q').value || '').trim().toLowerCase();
    const type = document.getElementById('type').value;
    const source = document.getElementById('source').value;
    const conf = document.getElementById('conf').value;

    const rows = [];

    for (const r of items) {
      const m = parseMetrics(r);
      const itType = investableType(m);
      if (itType === 'public') stats.public += 1;
      if (itType === 'private') stats.private += 1;
      const cb = confBucket(r.score);
      if (cb === 'high') stats.high += 1;

      const ft = fmtTime(r.fetched_at);
      try {
        const d = new Date(r.fetched_at);
        const k = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        if (k === todayKey) stats.today += 1;
      } catch(e) {}

      const { ticker, brand } = extractBrandTicker(m, r.title);
      const ve = (m && typeof m === 'object') ? (m.llm_enrich || null) : null;
      const trend = (ve && ve.main_trend) ? String(ve.main_trend) : (brand || (r.title || ''));
      const ctxPrimary = (ve && ve.context) ? String(ve.context) : '';
      if (ticker) byTicker.set(ticker, (byTicker.get(ticker) || 0) + 1);

      if (type !== 'all' && itType !== type) continue;
      if (source !== 'all' && (r.source || '') !== source) continue;
      if (conf !== 'all' && cb !== conf) continue;

      const hay = `${ticker} ${trend} ${brand} ${(r.title||'')} ${(r.text||'')} ${ctxPrimary} ${(m.keyword||'')}`.toLowerCase();
      if (q && !hay.includes(q)) continue;

      const exposure = [];
      if (itType === 'public') exposure.push('Direct stock');
      if (itType === 'private') exposure.push('Private / parent mapping');
      if (Array.isArray(m.investable)) {
        const inv = m.investable
          .map(x => x && (x.ticker ? `${x.brand||''} (${x.ticker})` : (x.parent ? `${x.brand||''} → ${x.parent}` : (x.brand||''))))
          .filter(Boolean);
        if (inv.length) exposure.push(inv.join(' • '));
      }

      const ctxBits = [];
      if (m.keyword) ctxBits.push(`kw: ${m.keyword}`);
      if (m.view_velocity != null) ctxBits.push(`vel: ${Number(m.view_velocity).toFixed(2)}`);
      if (m.views != null) ctxBits.push(`views: ${m.views}`);
      if (m.likes != null) ctxBits.push(`likes: ${m.likes}`);
      if (m.comments != null) ctxBits.push(`comments: ${m.comments}`);
      if (m.shares != null) ctxBits.push(`shares: ${m.shares}`);

      const contextPrimary = ctxPrimary || (r.text || r.title || '');
      const contextMeta = ctxBits.join(' | ');
      rows.push({ r, m, ticker, brand, trend, ft, cb, exposure: exposure.join(' — '), context: contextPrimary, contextMeta });
    }

    // chips
    const chips = [...byTicker.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 8);
    const chipsEl = document.getElementById('topChips');
    chipsEl.innerHTML = '';
    for (const [t, n] of chips) {
      const el = document.createElement('span');
      el.className = 'chip' + (n >= 3 ? ' green' : '');
      el.textContent = `${t} ×${n}`;
      el.title = 'click to filter';
      el.style.cursor = 'pointer';
      el.onclick = () => { document.getElementById('q').value = t; loadSignals().catch(()=>{}); };
      chipsEl.appendChild(el);
    }

    // stats UI
    const statsEl = document.getElementById('stats');
    statsEl.innerHTML = [
      `<span class="stat"><b>${stats.total}</b> signals</span>`,
      `<span class="stat"><b>${stats.public}</b> public</span>`,
      `<span class="stat"><b>${stats.private}</b> private</span>`,
      `<span class="stat"><b>${stats.high}</b> high conf</span>`,
      `<span class="stat"><b>${stats.today}</b> today</span>`,
    ].join('');

    // sort
    const sorted = sortRows(rows);

    // render table
    const tbody = document.getElementById('rows');
    tbody.innerHTML = '';

    for (const x of sorted) {
      const tr = document.createElement('tr');
      const url = x.r.url || '';
      const itemId = x.r.item_id || '';
      const hasShots = Array.isArray(x.m && x.m.screenshots) && x.m.screenshots.length > 0;
      const view = hasShots
        ? `<a href="#" class="viewLink" data-id="${escapeAttr(itemId)}">view</a>`
        : '';

      tr.setAttribute('data-id', itemId);
      tr.setAttribute('data-has-shots', hasShots ? '1' : '0');

      tr.innerHTML = `
        <td class="small">${escapeHtml(x.ft)}</td>
        <td><span class="chip">${escapeHtml(x.ticker || '—')}</span></td>
        <td>
          <div style="font-weight:650;">${escapeHtml(x.trend || x.brand || '')}</div>
          <div class="small">
            ${x.brand && x.trend && (x.brand !== x.trend) ? escapeHtml(x.brand) + ' • ' : ''}
            <a href="${escapeAttr(url)}" target="_blank" rel="noreferrer">open</a>
            ${view ? ` • ${view}` : ''}
          </div>
        </td>
        <td><span class="chip">${escapeHtml(x.r.source || '')}</span></td>
        <td>${confCell(x.r.score)}</td>
        <td>${escapeHtml(x.context || '')}<div class="small" style="margin-top:6px;">${escapeHtml(x.contextMeta || '')}</div></td>
        <td>${escapeHtml(x.exposure || '')}</td>
      `;
      tbody.appendChild(tr);
    }

    status.textContent = `Showing ${sorted.length} / ${items.length}`;
  }

  async function loadKeywords() {
    const res = await fetch('/api/keywords');
    const j = await res.json();
    document.getElementById('kw').value = j.text || '';
    document.getElementById('kwStatus').textContent = `Loaded from ${j.path}`;
  }

  async function saveKeywords() {
    const text = document.getElementById('kw').value || '';
    const res = await fetch('/api/keywords', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ text }),
    });
    const j = await res.json();
    document.getElementById('kwStatus').textContent = j.ok ? `Saved (${j.bytes} bytes) → ${j.path}` : `Save failed: ${j.error}`;
  }

  document.getElementById('refreshBtn').addEventListener('click', () => loadSignals().catch(()=>{}));
  document.getElementById('loadKw').addEventListener('click', () => loadKeywords().catch(()=>{}));
  document.getElementById('saveKw').addEventListener('click', () => saveKeywords().catch(()=>{}));

  setupSorting();

  // delegate clicks: view link OR row click (when screenshots exist)
  document.getElementById('rows').addEventListener('click', (ev) => {
    const a = ev.target && ev.target.closest ? ev.target.closest('a') : null;
    const viewA = a && a.classList && a.classList.contains('viewLink') ? a : null;

    if (viewA) {
      ev.preventDefault();
      const id = viewA.getAttribute('data-id') || '';
      if (id) openDrawer(id).catch(()=>{});
      return;
    }

    // If user clicked a regular link ("open"), let it behave normally.
    if (a) return;

    const tr = ev.target && ev.target.closest ? ev.target.closest('tr') : null;
    if (!tr) return;
    if (tr.getAttribute('data-has-shots') !== '1') return;
    const id = tr.getAttribute('data-id') || '';
    if (id) openDrawer(id).catch(()=>{});
  });

  // load initial
  loadSignals().catch(err => { document.getElementById('status').textContent = `Error: ${err}`; });
  loadKeywords().catch(()=>{});

  // soft auto-refresh
  setInterval(() => {
    const live = document.getElementById('live');
    live.textContent = 'Live';
    loadSignals().catch(()=>{});
  }, 30_000);
</script>
</body>
</html>
